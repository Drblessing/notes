# This configuration follows security best practices:
# - Key-based authentication only
# - No root login
# - Strong ciphers and algorithms
# - Connection limits and monitoring
#
# After editing, restart SSH: sudo systemctl restart ssh
# Test connection before closing current session!

#=== Basic Server Settings ===#
Port 22
# Port 2222  # Uncomment to use non-standard port for security through obscurity
AddressFamily any
ListenAddress 0.0.0.0
ListenAddress ::

#=== Protocol and Version ===#
Protocol 2

#=== Authentication Settings ===#
# Disable password authentication - use keys only
PasswordAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no
KbdInteractiveAuthentication no

# Enable public key authentication
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys .ssh/authorized_keys2


#=== User Access Control ===#
# Limit which users can SSH (uncomment and modify as needed)
# AllowUsers ubuntu admin developer
# AllowGroups ssh-users sudo
# DenyUsers guest

# Maximum authentication attempts
MaxAuthTries 3
MaxSessions 3




#=== Security Hardening ===#
# Disable unused authentication methods
UsePAM no
PermitUserEnvironment no
AllowAgentForwarding no  # Disable unless you need agent forwarding
AllowTcpForwarding no    # Disable unless you need port forwarding
GatewayPorts no
X11Forwarding no         # Disable X11 forwarding for security
PrintMotd no
PrintLastLog yes

# Disable unused features
PermitTunnel no
Banner none  # Don't reveal server information

#=== Cryptographic Settings ===#
# Use strong ciphers and algorithms
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr

# Strong MAC algorithms
MACs hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com,hmac-sha2-256,hmac-sha2-512

# Strong key exchange algorithms
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512

# Host key algorithms (prefer Ed25519 and ECDSA)
HostKeyAlgorithms rsa-sha2-512,rsa-sha2-256,ecdsa-sha2-nistp256,ssh-ed25519

# Specify host key files
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_ecdsa_key
HostKey /etc/ssh/ssh_host_ed25519_key

#=== Logging and Monitoring ===#
# Logging settings
SyslogFacility AUTH
LogLevel VERBOSE  # Log authentication attempts for security monitoring

# Enable detailed logging of key fingerprints
FingerprintHash sha256

#=== Advanced Security ===#
# Strict modes
StrictModes yes
UsePrivilegeSeparation sandbox

# Compression (disable for security, enable for slow connections)
Compression no

# Subsystem settings (disable SFTP if not needed)
Subsystem sftp /usr/lib/openssh/sftp-server
# Subsystem sftp internal-sftp  # Alternative: use internal SFTP

#=== Conditional Blocks ===#
# Example: Different settings for different user groups
# Match Group secure-users
#     AllowTcpForwarding yes
#     AllowAgentForwarding yes

# Example: Restrict SFTP-only users to their home directory
# Match Group sftp-only
#     ForceCommand internal-sftp
#     PasswordAuthentication no
#     ChrootDirectory %h
#     AllowTcpForwarding no
#     AllowAgentForwarding no
#     X11Forwarding no

# Example: Local network access with relaxed settings
# Match Address 192.168.1.0/24
#     PasswordAuthentication yes
#     PermitRootLogin yes

#=== Notes ===#
# 1. After modifying this file, test with: sudo sshd -t
# 2. Restart SSH service: sudo systemctl restart ssh
# 3. Check status: sudo systemctl status ssh
# 4. Monitor auth logs: sudo tail -f /var/log/auth.log
# 5. Always test new config before closing existing session!
#
# Security checklist after applying this config:
# □ Copy your public key to ~/.ssh/authorized_keys
# □ Test SSH connection with keys
# □ Confirm password auth is disabled
# □ Set up fail2ban for additional protection
# □ Consider changing default port (security through obscurity)
# □ Monitor /var/log/auth.log for failed attempts
